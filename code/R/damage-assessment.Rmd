---
title: "marshall-fire-damage"
author: "Maxwell C. Cook"
date: "1/11/2022"
output: html_document
---

```{r setup, include=F, warning=F}
knitr::opts_chunk$set(echo = TRUE)
source("setup.R")
```

## Marshall Fire, CO (2021): Residential Damage Assessment

With 1,084 home destroyed, the Marshall Fire is Colorado's most destructive wildfire disaster and in the top 15 most destructive wildfires in the western United States since 1999. 

```{r}
glimpse(ztrax.res)
```

## Location and Proportion of Homes Damaged and Destroyed

```{r pressure, echo=FALSE, fig.height=5, fig.width=6.5}
N <- dim(ztrax.res)[1]
grob <- grobTree(
   textGrob("*Based on available ZTRAX data \n(90% of total homes destroyed)*", 
            x=0.05,  y=0.05, hjust=0, gp=gpar(col="grey20", fontsize=8, fontface="italic")))
# Calculate proportion destroyed, damaged
# Map
p1 <- ggplot() +
  geom_sf(data=ztrax.res.hull, aes(color=DAMAGE), size=0.8, shape=3) +
  scale_color_manual(values = c("#fecc5c", "#bd0026", "#c2e699")) +
  geom_sf(data=evt, fill=NA, color="grey10") +
  labs(title="Marshall Fire, CO (2021) Damage Assessment",
       caption="Data Sources:\nBoulder County Sheriff's Office,\nZillow Transaction and Assessment Database (ZTRAX),\nNIFC Current Fire Perimeters",
       color="Status") +
  annotation_custom(grob) +
  theme_void() +
  theme(plot.title = element_text(size = 12), legend.position=c(0.1, 0.8),
        plot.caption = element_text(size=7))
p1
ggsave(p1, file = "../../figures/MarshallFire_DmgAssess_Map.png",
       width=6.5, height=5, dpi = 450) # adjust dpi accordingly
```

## Multinomial (Categorical) Regression

```{r fig.height=3.25, fig.width=3.5}
# run a simple model
p2 <- ztrax.res.evt %>%
  ggplot(aes(x='',fill=DAMAGE)) +
  geom_bar(aes(y = (..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = c("#fecc5c", "#bd0026", "#c2e699")) +
  geom_text(aes(label = ..count..), stat='count', position='fill', vjust=1.1, size=3) +
  labs(x="", fill="", y="% of Homes in Perim.",
       caption="*Based on available ZTRAX Data (90% of total)*") +
  theme_minimal() +
  theme(plot.caption = element_text(size=7))
p2
ggsave(p2, file = "../../figures/MarshallFire_DmgAssess_StatusPerc.png",
       width=3.5, height=3.25, dpi = 300) # adjust dpi accordingly
```

Check on the default priors.

```{r}
get_prior(data = ztrax.res.evt, family = categorical(link = logit, refcat = "Intact"), DAMAGE ~ 1)
```

Fit the intercept model.

```{r include=F, warning=F}
setwd("C:/Users/mccoo/OneDrive/mcook/earth-lab/marshall-fire/")
m1.1 <- brm(
  DAMAGE ~ 1, family = categorical(link = logit, refcat = "Intact"),
  data = ztrax.dmg,
  prior = c(prior(normal(0, 1), class = Intercept, dpar = muDestroyed),
            prior(normal(0, 1), class = Intercept, dpar = muDamaged)),
  iter = 2000, warmup = 1000, cores = 4, chains = 4,
  backend = "cmdstanr", threads = threading(4),
  control = list(adapt_delta = 0.99, max_treedepth=15), 
  sample_prior = TRUE, save_pars = save_pars(all=TRUE),
  seed = 1)
```

```{r}
summary(m1.1)
```

```{r}
fitted(m1.1)[1, , ] %>% 
  round(digits = 2) %>% 
  t()
```

```{r}
p2 <-
  ztrax.dmg %>% 
  mutate(DAMAGE = as.factor(DAMAGE)) %>%
  count(, career) %>% 
  group_by(fi) %>% 
  mutate(proportion = n / sum(n)) %>% 
  mutate(f = as.double(fi)) %>% 
  
  ggplot(aes(x = (f - 1) / 9, y = proportion, fill = career)) +
  geom_area() +
  scale_fill_manual(values = wes_palette("Moonrise2")[c(4, 2, 1)]) +
  xlab("family_income, descritized")
```

```{r}

```

```{r}

```

